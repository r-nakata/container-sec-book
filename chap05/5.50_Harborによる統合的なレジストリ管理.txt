# 5.50 Harborによる統合的なレジストリ管理
# 『コンテナセキュリティ』サンプルコード

# Harborのセットアップ (harbor.yml - Docker Compose)
cat > harbor.yml << 'EOF'
version: '2.3'
services:
  harbor-core:
    image: goharbor/harbor-core:v2.5.0
    environment:
      CORE_SECRET: harbor_secret
      JOBSERVICE_SECRET: jobservice_secret
    volumes:
      - /data/harbor/core:/data
    depends_on:
      - harbor-db
      - redis

  harbor-db:
    image: goharbor/harbor-db:v2.5.0
    environment:
      POSTGRES_PASSWORD: root123
    volumes:
      - /data/harbor/database:/var/lib/postgresql/data
EOF

docker-compose -f harbor.yml up -d

# コンプライアンス要件を満たすプロジェクトの作成
curl -X POST "https://harbor.company.com/api/v2.0/projects" \
  -H "Authorization: Basic $(echo -n admin:Harbor12345 | base64)" \
  -H "Content-Type: application/json" \
  -d '{
    "project_name": "compliance-project",
    "metadata": {
      "auto_scan": "true",
      "severity": "critical",
      "reuse_sys_cve_allowlist": "true"
    }
  }'

# プロジェクトへのスキャナー設定
curl -X PUT "https://harbor.company.com/api/v2.0/projects/1/scanner" \
  -H "Authorization: Basic $(echo -n admin:Harbor12345 | base64)" \
  -H "Content-Type: application/json" \
  -d '{
    "scanner_uuid": "system-scanner-uuid"
  }'

# Content Trustの有効化と脆弱性防止の設定
curl -X PUT "https://harbor.company.com/api/v2.0/projects/1" \
  -H "Authorization: Basic $(echo -n admin:Harbor12345 | base64)" \
  -H "Content-Type: application/json" \
  -d '{
    "metadata": {
      "enable_content_trust": "true",
      "auto_scan": "true",
      "severity": "high",
      "prevent_vul": "true"
    }
  }'

# 監査ログのエクスポート
curl -X GET "https://harbor.company.com/api/v2.0/audit-logs" \
  -H "Authorization: Basic $(echo -n admin:Harbor12345 | base64)" \
  > audit_logs.json
