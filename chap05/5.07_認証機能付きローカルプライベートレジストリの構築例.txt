# 5.07 認証機能付きローカルプライベートレジストリの構築例
# 『コンテナセキュリティ』サンプルコード

# 認証用のディレクトリを作成
mkdir -p /opt/registry/{auth,certs,data}

# Basic認証用のユーザーを作成
docker run --rm --entrypoint htpasswd \
  httpd:2 -Bbn admin password123 > /opt/registry/auth/htpasswd

# 自己署名証明書の作成（テスト環境用）
openssl req -newkey rsa:4096 -nodes -sha256 \
  -keyout /opt/registry/certs/domain.key \
  -x509 -days 365 \
  -out /opt/registry/certs/domain.crt \
  -subj "/CN=registry.local"

# 認証・TLS有効化でレジストリを起動
docker run -d \
  --name secure-registry \
  --restart=always \
  -p 5000:5000 \
  -v /opt/registry/data:/var/lib/registry \
  -v /opt/registry/certs:/certs \
  -v /opt/registry/auth:/auth \
  -e REGISTRY_HTTP_TLS_CERTIFICATE=/certs/domain.crt \
  -e REGISTRY_HTTP_TLS_PRIVATE_KEY=/certs/domain.key \
  -e REGISTRY_AUTH=htpasswd \
  -e REGISTRY_AUTH_HTPASSWD_PATH=/auth/htpasswd \
  -e REGISTRY_AUTH_HTPASSWD_REALM="Registry Realm" \
  registry:2
