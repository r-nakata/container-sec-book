# 8.25 TLS証明書のSecretとIngress設定
# 『コンテナセキュリティ』サンプルコード

# TLS証明書をSecretとして保存
apiVersion: v1
kind: Secret
metadata:
  name: api-tls-cert
  namespace: production
type: kubernetes.io/tls
data:
  tls.crt: <Base64エンコードされた証明書>
  tls.key: <Base64エンコードされた秘密鍵>
---
# TLSを有効化したIngress
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: api-ingress
  namespace: production
  annotations:
    # HTTPからHTTPSへの強制リダイレクト
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    # TLS 1.2以上のみ許可
    nginx.ingress.kubernetes.io/ssl-protocols: "TLSv1.2 TLSv1.3"
    # HSTS（HTTP Strict Transport Security）の有効化
    nginx.ingress.kubernetes.io/hsts: "true"
    nginx.ingress.kubernetes.io/hsts-max-age: "31536000"
spec:
  tls:
  - hosts:
    - api.example.com
    secretName: api-tls-cert
  rules:
  - host: api.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: api-gateway
            port:
              number: 8080
