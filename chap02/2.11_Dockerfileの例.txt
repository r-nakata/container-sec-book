# 2.11 Dockerfileの例
# 『コンテナセキュリティ』サンプルコード

# ベースイメージの指定
FROM ubuntu:20.04

# ビルド引数の定義
ARG VERSION=1.0

# メタデータの追加
LABEL version=$VERSION
LABEL description="Advanced Dockerfile example"

# 環境変数の設定
ENV APP_HOME=/app

# システムのアップデートと必要なパッケージのインストール
RUN apt-get update && apt-get install -y \
    python3 \
    python3-pip \
    curl \
    && rm -rf /var/lib/apt/lists/*

# 作業ディレクトリの設定
WORKDIR $APP_HOME

# 依存関係ファイルのコピーとインストール
COPY requirements.txt .
RUN pip3 install --no-cache-dir -r requirements.txt

# アプリケーションのコピー
COPY . .

# ボリュームの定義
VOLUME ["/data"]

# ポートの公開
EXPOSE 8080

# 実行ユーザーの作成と切り替え
RUN useradd -m myuser
USER myuser

# ヘルスチェックの定義
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
  CMD curl -f http://localhost:8080/health || exit 1

# デフォルトシェルの変更
SHELL ["/bin/bash", "-c"]

# 停止シグナルの設定
STOPSIGNAL SIGTERM

# 子イメージ用のトリガー命令
ONBUILD COPY config.json /app/config/

# 起動コマンド
CMD ["python3", "app.py"]
